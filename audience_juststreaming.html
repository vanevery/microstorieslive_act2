<html>
	<head>
		<script src="http://cdn.peerjs.com/0.3/peer.min.js"></script>		
		<script type="text/javascript" src="/socket.io/socket.io.js"></script>
		<script type="text/javascript">
		
			var socket = io.connect('/');
			
			socket.on('connect', function() {
				console.log("Connected");
				if (peer_id != null) {
					// We already have a peer_id so let's send it
					socket.emit('peer_id', peer_id);
				}
			});


			/////////////
			
			// We'll use a global variable to hold on to our id from PeerJS
			var peer_id = null;

			// Register for an API Key:	http://peerjs.com/peerserver
			var peer = new Peer({key: 'uohu08l7r6swcdi'});

			// Get an ID from the PeerJS server		
			peer.on('open', function(id) {
			  console.log('My peer ID is: ' + id);
			  peer_id = id;
			  if (socket != null) {
				socket.emit('peer_id', peer_id);
			  }
			});
			
			peer.on('call', function(incoming_call) {
				console.log("Got a call!");
				incoming_call.answer(null); // Answer the call with our stream from getUserMedia
				incoming_call.on('stream', function(remoteStream) {  // we receive a getUserMedia stream from the remote caller
					// And attach it to a video object
					var videoElement = document.getElementById('myvideo');
					videoElement.src = window.URL.createObjectURL(remoteStream) || remoteStream;
					videoElement.play();
					//drawVideo(videoElement, context, videoElement.width, videoElement.height);
				});
			});
			
			/////
	
			/*
			function drawVideo(video, context, width, height) {
				if (video.paused || video.ended) return;
				context.drawImage(video, 0, 0, width, height);
				setTimeout(drawVideo, 20, video, context, width, height);
			}
			*/
		</script>
		<style>
			body {
				background-color: #ffffff;
			}
			
			#myvideo {
				visibility: visible;
			}
			
			#video_div {
				position: absolute;
				top: 0px;
				left: 0px;
				width: 854px;
				margin: 0, auto;
				z-index: 0;
			}

			#canvas_div {
				position: absolute;
				top: 0px;
				left: 0px;
				width: 854px;
				margin: 0, auto;
				z-index: 2;
			}
			
			#canvas_other_div {
				position: absolute;
				top: 0px;
				left: 0px;
				width: 854px;
				margin: 0, auto;
				z-index: 1;
			}
						
			#text_div {
				position: absolute;
				top: 500px;
				width: 854px;
				margin: 0, auto;
				color: #dddddd;
				font-size: large;
			}
			
			#instructions {
				position: absolute;
				top: 550px;
				width: 854px;
				margin: 0, auto;
				color: #dddddd;
				font-size: large;
			}
		</style>		
	</head>
	<body>
		<div id="content_wrapper">
			<div id="video_div">
				<video width="854" height="480" id="myvideo"></video>
			</div>
		</div>
		<div id="instructions">
			<a href="http://webchat.freenode.net/?channels=itpliv" target="_NEW">Chat</a>
		</div>
	</body>
</html>
